name: Deploy to GCP Cloud Run

on:
  push:
    branches: [main]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  BACKEND_SERVICE: llm-aggregator-backend
  FRONTEND_SERVICE: llm-aggregator-frontend
  DB_INSTANCE: llm-aggregator-db

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev
      
      - name: Build and push backend image
        run: |
          cd backend
          # Submit builds asynchronously to avoid log streaming issues
          BUILD_ID1=$(gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/llm-aggregator/$BACKEND_SERVICE:$GITHUB_SHA --async --format="value(id)")
          BUILD_ID2=$(gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/llm-aggregator/$BACKEND_SERVICE:latest --async --format="value(id)")
          echo "Build IDs: $BUILD_ID1, $BUILD_ID2"
          # Wait for builds to complete
          for build_id in $BUILD_ID1 $BUILD_ID2; do
            echo "Waiting for build $build_id to complete..."
            while true; do
              STATUS=$(gcloud builds describe $build_id --format="value(status)")
              if [ "$STATUS" = "SUCCESS" ]; then
                echo "Build $build_id completed successfully"
                break
              elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ]; then
                echo "Build $build_id failed with status: $STATUS"
                exit 1
              fi
              sleep 5
            done
          done
      
      - name: Get backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format='value(status.url)' 2>/dev/null || echo "")
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
      
      - name: Deploy backend to Cloud Run
        run: |
          gcloud run deploy $BACKEND_SERVICE \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/llm-aggregator/$BACKEND_SERVICE:$GITHUB_SHA \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --set-secrets=DATABASE_URL=db-connection-string:latest,ENCRYPTION_KEY=encryption-key:latest,JWT_SECRET_KEY=jwt-secret:latest,DB_PASSWORD=db-password:latest,SMTP_PASSWORD=smtp-password:latest \
            --set-env-vars="JWT_ALGORITHM=HS256,JWT_EXPIRATION_HOURS=24,CLOUD_SQL_CONNECTION_NAME=$PROJECT_ID:$REGION:$DB_INSTANCE,SMTP_HOST=smtp.gmail.com,SMTP_PORT=587,SMTP_USER=ilya@lab4.berlin,SMTP_FROM_EMAIL=ilya@lab4.berlin" \
            --add-cloudsql-instances=$PROJECT_ID:$REGION:$DB_INSTANCE \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300
      
      - name: Get deployed backend URL
        id: deployed-backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend deployed at: $BACKEND_URL"

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev
      
      - name: Get backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
      
      - name: Build frontend
        run: |
          cd frontend
          echo "VITE_API_URL=${{ needs.deploy-backend.outputs.deployed-backend-url }}" > .env.production
          npm install
          npm run build
      
      - name: Build and push frontend image
        run: |
          cd frontend
          # Submit builds asynchronously to avoid log streaming issues
          BUILD_ID1=$(gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/llm-aggregator/$FRONTEND_SERVICE:$GITHUB_SHA --async --format="value(id)")
          BUILD_ID2=$(gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/llm-aggregator/$FRONTEND_SERVICE:latest --async --format="value(id)")
          echo "Build IDs: $BUILD_ID1, $BUILD_ID2"
          # Wait for builds to complete
          for build_id in $BUILD_ID1 $BUILD_ID2; do
            echo "Waiting for build $build_id to complete..."
            while true; do
              STATUS=$(gcloud builds describe $build_id --format="value(status)")
              if [ "$STATUS" = "SUCCESS" ]; then
                echo "Build $build_id completed successfully"
                break
              elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "CANCELLED" ]; then
                echo "Build $build_id failed with status: $STATUS"
                exit 1
              fi
              sleep 5
            done
          done
      
      - name: Deploy frontend to Cloud Run
        run: |
          gcloud run deploy $FRONTEND_SERVICE \
            --image $REGION-docker.pkg.dev/$PROJECT_ID/llm-aggregator/$FRONTEND_SERVICE:$GITHUB_SHA \
            --platform managed \
            --region $REGION \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --port=80
      
      - name: Get deployed frontend URL
        run: |
          FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE --region=$REGION --format='value(status.url)')
          echo "Frontend deployed at: $FRONTEND_URL"
          echo "Backend URL: ${{ needs.deploy-backend.outputs.deployed-backend-url }}"


